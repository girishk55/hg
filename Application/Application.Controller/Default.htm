<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Orders</title>
    <link href="Content/Common.css" rel="stylesheet" type="text/css" />
    <link href="http://ajax.microsoft.com/ajax/jquery.ui/1.8.9/themes/ui-lightness/jquery-ui.css"
        rel="stylesheet" type="text/css" />    
    <script type="text/javascript" src="Scripts/jquery-1.6.2.js"></script>
    <script src="Scripts/jquery-ui-1.8.11.min.js" type="text/javascript"></script>
    <script src="Scripts/jQuery.tmpl.js" type="text/javascript"></script>
</head>
<body>
    <p>
        Id:
        <input type="text" id="orderId" />
        <input type="button" id="Search" value="Search" />
        <input type="button" id="GetAll" value="Get All" />
        <label style="padding-left:500px;">Total cart value : $</label>
        <label id="lblCartTotal">0.00</label>
        <input type="button" id="Checkout" value="Checkout" />
    </p>
    <div id="divMain">
        <div id="divCategory">
            <ul id="categories">
            </ul>
        </div>
        <div id="divProductDetails">
            <ul id="products">
            </ul>
        </div>
        <div id="divCartProduct">
            <ul id="CartProducts">
            </ul>
        </div>
    </div>
    <script type="text/javascript">
        $(function () {
            var valuesAddress = "/api/productcategories";
            var URL = "http://localhost:50284/api/";
            $.getJSON(
                                    valuesAddress,
                                    function (data) {
                                        var parents = jQuery.grep(data, function (a) { return a.ParentProductCategoryID == null });
                                        var childs = jQuery.grep(data, function (a) { return a.ParentProductCategoryID != null });
                                        $.each(parents,
                                            function (index, value) {
                                                var categorydata = []; //= value.ProductCategoryID + "," + value.Name + "#";
                                                var subCategory = '';
                                                var subChild = jQuery.grep(childs, function (a) { return a.ParentProductCategoryID == value.ProductCategoryID });
                                                $.each(subChild,
                                                    function (index, item) {
                                                        var serviceURL = URL + "products/" + item.ProductCategoryID;
                                                        subCategory = subCategory + "  " + "<a href=" + serviceURL + " class='menuButton'>" + item.Name + "</a>";
                                                    });
                                                categorydata.push({
                                                    'ParentCategory': value.Name,
                                                    'ChildCategory': subCategory
                                                });
                                                $("#categoryTemplate").tmpl(categorydata).appendTo("#categories");
                                                $("#" + value.Name).html(subCategory);
                                            });
                                    }
                                );

            $("#Search").click(function () {
                var id = "/" + $("#orderId").val();
                $.ajax({
                    url: valuesAddress + id,
                    type: "GET",
                    success: function (value) {
                        alert(value.Name);
                        $("#orders").html("");
                        if (value == null) {
                            $("#orders").html("Record Not Found");
                        }
                        else {
                            $("#orderTemplate").tmpl(value).appendTo("#orders");
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        $("#orders").html("");
                        $("#orders").html("Record Not Found");
                    }
                });
            });

            $("#Checkout").click(function () {
                $("#divMain").hide();
            });

            $("#GetAll").click(function () {
                $.ajax({
                    url: valuesAddress,
                    type: "GET",
                    dataType: "json",
                    success: function (value) {
                        alert(value);
                        $("#orders").html("");
                        $("#orderTemplate").tmpl(value).appendTo("#orders");
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        $("#orderTemplate").tmpl(textStatus).appendTo("#orders");
                    }
                });
            });

            $(".menuButton").live("click", function () {
                $.ajax({
                    type: "GET",
                    url: $(this).attr("href"),
                    context: this,
                    success: function (value) {
                        $("#products").html("");
                        $("#ProductTemplate").tmpl(value).appendTo("#products");
                    }
                });
                return false;
            });

            $("body").addClass("ui-widget");
            $("input[type=\"submit\"], .menuButton").button()

        });

            function AddToCart(listPrice, productId) {
                var productQuantity = $("#txt" + productId).val()
                if (productQuantity == "" || productQuantity == null) {
                    alert("Please select quantity for this product.")
                    return;
                }
                else {
                    var totalPrice = parseFloat($("#lblCartTotal").html()) + (parseFloat(listPrice) * parseFloat(productQuantity));
                    $("#lblCartTotal").html(totalPrice.toFixed(2));
                    var cartData = [];
                    cartData.push({
                        'ProductID': productId,
                        'Quantity': productQuantity,
                        'ProductPrice': listPrice,
                        'TotalPrice': (parseFloat(listPrice) * parseFloat(productQuantity)).toFixed(2)
                    });
                    $("#CartProductTemplate").tmpl(cartData).appendTo("#CartProducts");
                }
            }
            
    </script>
    <script id="categoryTemplate" type="text/html">
            <li class="ui-widget-content ui-corner-all">
                <h1 class="ui-widget-header"> ${ ParentCategory } </h1>
                <p class="subMenu" id="${ ParentCategory }"></p>
            </li>
    </script>
    <script id="ProductTemplate" type="text/html">
            <li class="ui-widget-content ui-corner-all">
                <h5 class="ui-widget-header">${ Name }</h5>
                <p>Code : ${ ProductNumber } <br /> Price : $ ${ ListPrice } <br /> 
                    Color : ${ Color } <br /> Size/Weight : ${ Size }/${ Weight }<br />
                    Quantity : <input class="quantityText" type="text" id="txt${ ProductID }" />
                     <a onclick="AddToCart(${ ListPrice }, ${ ProductID });" class="AddToCart"><img alt='Add to Cart' title='Add to Cart' src="Images/addCart.gif" /></a></p>
            </li>
    </script>
    <script id="CartProductTemplate" type="text/html">
            <li class="ui-widget-content ui-corner-all">
                <p>ID : ${ ProductID } Quantity : ${ Quantity } Unit Price : ${ ProductPrice } Total Price : ${ TotalPrice } </p>
            </li>
    </script>
</body>
</html>
